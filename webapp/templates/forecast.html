{% extends "base.html" %}

{% block title %}Forecast Dashboard - Phoenyra BESS Trade{% endblock %}

{% block content %}
<div class="px-4 py-6">
    <!-- Header -->
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-white mb-2">
            <i class="fas fa-crystal-ball mr-2"></i>Preis- und Lastprognosen
        </h2>
        <p class="text-gray-300">Day-Ahead und Intraday Forecasts für optimales BESS Trading</p>
    </div>

    <!-- Control Panel -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Day-Ahead Forecast Request -->
        <div class="dark-card p-6">
            <h3 class="text-xl font-bold text-white mb-4">
                <i class="fas fa-sun mr-2 text-yellow-400"></i>Day-Ahead Forecast
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Marktgebiet</label>
                    <input type="text" id="da-area" value="AT" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-yellow-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Prognosehorizont (Stunden)</label>
                    <input type="number" id="da-horizon" value="24" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-yellow-500">
                </div>
                <button onclick="requestDayAheadForecast()" class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 shadow-lg">
                    <i class="fas fa-chart-line mr-2"></i>Forecast anfordern
                </button>
            </div>
        </div>

        <!-- Intraday Forecast Request -->
        <div class="dark-card p-6">
            <h3 class="text-xl font-bold text-white mb-4">
                <i class="fas fa-clock mr-2 text-blue-400"></i>Intraday Forecast
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Marktgebiet</label>
                    <input type="text" id="id-area" value="AT" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Prognosehorizont (Stunden)</label>
                    <input type="number" id="id-horizon" value="12" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500">
                </div>
                <button onclick="requestIntradayForecast()" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 shadow-lg">
                    <i class="fas fa-bolt mr-2"></i>Forecast anfordern
                </button>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Price Forecast Chart -->
        <div class="dark-card p-6">
            <h3 class="text-lg font-bold text-white mb-4">
                <i class="fas fa-euro-sign mr-2 text-green-400"></i>Strompreisprognose (EUR/MWh)
            </h3>
            <div class="h-64 relative">
                <canvas id="price-chart"></canvas>
            </div>
        </div>

        <!-- Load Forecast Chart -->
        <div class="dark-card p-6">
            <h3 class="text-lg font-bold text-white mb-4">
                <i class="fas fa-bolt mr-2 text-yellow-400"></i>Lastprognose (MW)
            </h3>
            <div class="h-64 relative">
                <canvas id="load-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Generation Forecasts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Solar Forecast -->
        <div class="dark-card p-6">
            <h3 class="text-lg font-bold text-white mb-4">
                <i class="fas fa-sun mr-2 text-orange-400"></i>Solarprognose (MW)
            </h3>
            <div class="h-64 relative">
                <canvas id="solar-chart"></canvas>
            </div>
        </div>

        <!-- Wind Forecast -->
        <div class="dark-card p-6">
            <h3 class="text-lg font-bold text-white mb-4">
                <i class="fas fa-wind mr-2 text-cyan-400"></i>Windprognose (MW)
            </h3>
            <div class="h-64 relative">
                <canvas id="wind-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- SOC Target -->
    <div class="dark-card p-6">
        <h3 class="text-lg font-bold text-white mb-4">
            <i class="fas fa-battery-three-quarters mr-2 text-blue-400"></i>Optimaler SOC-Zielverlauf (%)
        </h3>
        <div class="h-64 relative">
            <canvas id="soc-chart"></canvas>
        </div>
    </div>

    <!-- Status Messages -->
    <div id="forecast-status" class="mt-6 hidden">
        <div class="dark-card p-4 bg-blue-900 bg-opacity-50 border-blue-500">
            <p class="text-blue-300"><i class="fas fa-info-circle mr-2"></i><span id="status-message"></span></p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let priceChart, loadChart, solarChart, windChart, socChart;
let currentJobId = null;

// Initialize charts with Chart.js
function initCharts() {
    const createChart = (canvasId, label, color, yAxisTitle, yMin, yMax) => {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return null;
        
        const ctx = canvas.getContext('2d');
        return new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: label,
                    data: [],
                    borderColor: color,
                    backgroundColor: color.replace(')', ', 0.1)').replace('rgb', 'rgba'),
                    borderWidth: 2,
                    tension: 0.3,
                    fill: false,
                    pointRadius: 0,
                    pointHoverRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        labels: { color: '#ffffff' }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        callbacks: {
                            title: function(context) {
                                if (context && context.length > 0 && context[0].parsed && typeof context[0].parsed.x === 'number') {
                                    const date = new Date(context[0].parsed.x);
                                    if (!isNaN(date.getTime())) {
                                        return date.toLocaleDateString('de-DE') + ' ' + 
                                               String(date.getHours()).padStart(2, '0') + ':' + 
                                               String(date.getMinutes()).padStart(2, '0');
                                    }
                                }
                                return '';
                            },
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        ticks: {
                            color: '#ffffff',
                            font: { size: 11 },
                            callback: function(value, index, values) {
                                if (typeof value !== 'number' || !Number.isFinite(value)) {
                                    return '';
                                }
                                try {
                                    const date = new Date(value);
                                    if (isNaN(date.getTime()) || date.getTime() === 0) {
                                        return '';
                                    }
                                    const year = date.getFullYear();
                                    if (year < 2000 || year > 2100) {
                                        return '';
                                    }
                                    return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' }) + ' ' +
                                           String(date.getHours()).padStart(2, '0') + ':' +
                                           String(date.getMinutes()).padStart(2, '0');
                                } catch (e) {
                                    return '';
                                }
                            },
                            maxTicksLimit: 10
                        },
                        grid: { color: '#374151' }
                    },
                    y: {
                        title: {
                            display: true,
                            text: yAxisTitle,
                            color: '#ffffff',
                            font: { size: 12 }
                        },
                        ticks: {
                            color: '#ffffff',
                            font: { size: 11 },
                            callback: function(value) {
                                return value.toFixed(2);
                            }
                        },
                        min: yMin,
                        max: yMax,
                        grid: { color: '#374151' }
                    }
                }
            }
        });
    };

    priceChart = createChart('price-chart', 'Preis', '#10b981', 'EUR/MWh', undefined, undefined);
    loadChart = createChart('load-chart', 'Last', '#f59e0b', 'MW', undefined, undefined);
    solarChart = createChart('solar-chart', 'Solar', '#fb923c', 'MW', undefined, undefined);
    windChart = createChart('wind-chart', 'Wind', '#06b6d4', 'MW', undefined, undefined);
    socChart = createChart('soc-chart', 'SOC Ziel', '#3b82f6', '%', 0, 100);
}

function showStatus(message, type = 'info') {
    const statusDiv = document.getElementById('forecast-status');
    const statusMsg = document.getElementById('status-message');
    statusDiv.classList.remove('hidden');
    statusMsg.textContent = message;
}

async function requestDayAheadForecast() {
    const area = document.getElementById('da-area').value;
    const horizon = parseInt(document.getElementById('da-horizon').value);
    
    showStatus('Day-Ahead Forecast wird angefordert...');
    
    try {
        const response = await fetch('/api/forecast/dayahead', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ area, horizon_h: horizon, granularity_min: 15 })
        });
        
        const data = await response.json();
        if (data.job_id) {
            currentJobId = data.job_id;
            showStatus('Forecast Job gestartet: ' + data.job_id);
            setTimeout(() => fetchForecastResults(data.job_id), 1000);
        }
    } catch (error) {
        showStatus('Fehler: ' + error.message);
    }
}

async function requestIntradayForecast() {
    const area = document.getElementById('id-area').value;
    const horizon = parseInt(document.getElementById('id-horizon').value);
    
    showStatus('Intraday Forecast wird angefordert...');
    
    try {
        const response = await fetch('/api/forecast/intraday', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ area, horizon_h: horizon, granularity_min: 15 })
        });
        
        const data = await response.json();
        if (data.job_id) {
            currentJobId = data.job_id;
            showStatus('Forecast Job gestartet: ' + data.job_id);
            setTimeout(() => fetchForecastResults(data.job_id), 1000);
        }
    } catch (error) {
        showStatus('Fehler: ' + error.message);
    }
}

async function fetchForecastResults(jobId) {
    try {
        const response = await fetch(`/api/forecast/status/${jobId}`);
        const data = await response.json();
        
        if (data.status === 'done' && data.series) {
            showStatus(`Forecast erfolgreich abgerufen (${data.series.length} Datenpunkte)`);
            updateCharts(data.series);
        } else {
            showStatus('Forecast läuft noch...');
            setTimeout(() => fetchForecastResults(jobId), 2000);
        }
    } catch (error) {
        showStatus('Fehler beim Abrufen: ' + error.message);
    }
}

function updateCharts(series) {
    const priceData = series.map(d => ({ x: new Date(d.ts).getTime(), y: d.price_eur_mwh }));
    const loadData = series.map(d => ({ x: new Date(d.ts).getTime(), y: d.load_mw }));
    const solarData = series.map(d => ({ x: new Date(d.ts).getTime(), y: d.gen_solar_mw }));
    const windData = series.map(d => ({ x: new Date(d.ts).getTime(), y: d.gen_wind_mw }));
    const socData = series.map(d => ({ x: new Date(d.ts).getTime(), y: d.soc_target_pct }));
    
    // Update Chart.js datasets
    if (priceChart) {
        priceChart.data.datasets[0].data = priceData;
        priceChart.update('none');
    }
    if (loadChart) {
        loadChart.data.datasets[0].data = loadData;
        loadChart.update('none');
    }
    if (solarChart) {
        solarChart.data.datasets[0].data = solarData;
        solarChart.update('none');
    }
    if (windChart) {
        windChart.data.datasets[0].data = windData;
        windChart.update('none');
    }
    if (socChart) {
        socChart.data.datasets[0].data = socData;
        socChart.update('none');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    // Auto-request Day-Ahead forecast on load
    setTimeout(() => requestDayAheadForecast(), 500);
});
</script>
{% endblock %}

