<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Phoenyra BESS Trade Dashboard{% endblock %}</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='phoenyra_logo.png') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='phoenyra_logo.png') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Magic UI Styles */
        .gradient-bg {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
            position: relative;
        }
        
        .gradient-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.1) 0%, 
                transparent 50%, 
                rgba(255, 215, 0, 0.05) 100%);
            pointer-events: none;
        }
        
        /* Dark Mode Cards with Gold Standard */
        .dark-card {
            position: relative;
            background: linear-gradient(135deg, rgba(31, 41, 55, 0.95) 0%, rgba(45, 55, 72, 0.95) 100%);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 16px;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .dark-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.05) 0%, 
                transparent 50%, 
                rgba(255, 215, 0, 0.03) 100%);
            pointer-events: none;
        }
        
        .dark-card:hover {
            border-color: rgba(255, 215, 0, 0.4);
            box-shadow: 
                0 10px 25px rgba(0, 0, 0, 0.3),
                0 0 20px rgba(255, 215, 0, 0.1);
            transform: translateY(-2px);
        }
        
        
        /* Magic Card Hover Effect */
        .magic-card {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            transition: all 0.3s ease;
        }
        
        .magic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        /* Shimmer Button Effect */
        .shimmer-button {
            position: relative;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .shimmer-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }
        
        .shimmer-button:hover::before {
            left: 100%;
        }
        
        /* Animated Text Effects */
        .aurora-text {
            background: linear-gradient(45deg, #ff00aa, #7928CA, #0070F3, #38bdf8);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: aurora 4s ease-in-out infinite;
        }
        
        
        @keyframes aurora {
            0%, 100% { background-position: 0% 50%; }
            25% { background-position: 50% 0%; }
            50% { background-position: 100% 50%; }
            75% { background-position: 50% 100%; }
        }
        
        /* Number Ticker Animation */
        .number-ticker {
            font-variant-numeric: tabular-nums;
            transition: all 0.3s ease;
        }
        
        /* Particle Background */
        .particle-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0; }
            10%, 90% { opacity: 1; }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        
        /* Status Indicators */
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-online { 
            background-color: #10b981; 
            box-shadow: 0 0 10px #10b981;
        }
        
        .status-offline { 
            background-color: #ef4444; 
            box-shadow: 0 0 10px #ef4444;
        }
        
        .status-warning { 
            background-color: #f59e0b; 
            box-shadow: 0 0 10px #f59e0b;
        }
        
        /* Glowing Effects */
        .glow {
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }
        
        .glow-green {
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }
        
        .glow-red {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }
        
        /* Custom Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Gold Standard Background */
        .gold-bg {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            position: relative;
        }
        
        .gold-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 215, 0, 0.05) 0%, transparent 50%);
            pointer-events: none;
        }
        
        
        /* Gold Footer */
        .gold-footer {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            border-top: 1px solid rgba(255, 215, 0, 0.3);
            position: relative;
        }
        
        .gold-footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.08) 0%, 
                transparent 50%, 
                rgba(255, 215, 0, 0.05) 100%);
            pointer-events: none;
        }
        
        /* Active Menu Item Styling */
        .nav-link.bg-white {
            background-color: rgba(255, 255, 255, 0.12) !important;
            border-bottom: 2px solid rgba(255, 215, 0, 0.6) !important;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.15);
        }
        
        /* Shadcn-inspired Components */
        .shadcn-card {
            background: hsl(222.2, 47.4%, 11.2%);
            border: 1px solid hsl(217.2, 32.6%, 17.5%);
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        
        .shadcn-card:hover {
            border-color: hsl(217.2, 32.6%, 25%);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .shadcn-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            padding: 0.5rem 1rem;
            border: none;
            cursor: pointer;
            font-family: system-ui, -apple-system, sans-serif;
            line-height: 1.25rem;
        }
        
        .shadcn-btn:focus-visible {
            outline: 2px solid hsl(217.2, 91.2%, 59.8%);
            outline-offset: 2px;
        }
        
        .shadcn-btn-primary {
            background-color: hsl(217.2, 91.2%, 59.8%);
            color: white;
        }
        
        .shadcn-btn-primary:hover {
            background-color: hsl(217.2, 91.2%, 54%);
        }
        
        .shadcn-btn-primary:active {
            background-color: hsl(217.2, 91.2%, 50%);
        }
        
        .shadcn-btn-secondary {
            background-color: hsl(217.2, 32.6%, 17.5%);
            color: hsl(0, 0%, 98%);
            border: 1px solid hsl(217.2, 32.6%, 25%);
        }
        
        .shadcn-btn-secondary:hover {
            background-color: hsl(217.2, 32.6%, 20%);
            border-color: hsl(217.2, 32.6%, 30%);
        }
        
        .shadcn-btn-destructive {
            background-color: hsl(0, 84.2%, 60.2%);
            color: white;
        }
        
        .shadcn-btn-destructive:hover {
            background-color: hsl(0, 84.2%, 55%);
        }
        
        .shadcn-btn-destructive:active {
            background-color: hsl(0, 84.2%, 50%);
        }
        
        .shadcn-input {
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            border: 1px solid hsl(217.2, 32.6%, 17.5%);
            background-color: hsl(222.2, 47.4%, 11.2%);
            color: hsl(0, 0%, 98%);
            font-size: 0.875rem;
            line-height: 1.25rem;
            transition: all 0.2s ease;
            font-family: system-ui, -apple-system, sans-serif;
        }
        
        .shadcn-input::placeholder {
            color: hsl(0, 0%, 63.9%);
        }
        
        .shadcn-input:focus {
            outline: none;
            border-color: hsl(217.2, 91.2%, 59.8%);
            box-shadow: 0 0 0 2px hsl(217.2, 91.2%, 59.8%, 0.2);
        }
        
        .shadcn-input:hover {
            border-color: hsl(217.2, 32.6%, 25%);
        }
        
        .longterm-btn.active {
            background-color: hsl(217.2, 91.2%, 59.8%);
            color: white;
            border-color: hsl(217.2, 91.2%, 59.8%);
        }
        
        .longterm-btn.active:hover {
            background-color: hsl(217.2, 91.2%, 54%);
        }
        
        /* Chart.js Canvas Size Fix - Prevent infinite height */
        /* Container divs with fixed height */
        #priceChart,
        #vwapChart,
        #longtermChart {
            display: block !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        /* Ensure chart containers have fixed height */
        #priceChart {
            max-height: 256px !important; /* h-64 = 256px */
            height: 256px !important;
        }
        
        #vwapChart {
            max-height: 256px !important; /* h-64 = 256px */
            height: 256px !important;
        }
        
        #longtermChart {
            max-height: 384px !important; /* h-96 = 384px */
            height: 384px !important;
        }
        
        /* Ensure parent divs have correct height */
        .h-64 {
            height: 256px !important;
            max-height: 256px !important;
            overflow: hidden !important;
        }
        
        .h-96 {
            height: 384px !important;
            max-height: 384px !important;
            overflow: hidden !important;
        }
        
        /* Ensure chart container divs have correct height - use class selector */
        div.h-64 {
            height: 256px !important;
            max-height: 256px !important;
            overflow: hidden !important;
            position: relative !important;
        }
        
        div.h-96 {
            height: 384px !important;
            max-height: 384px !important;
            overflow: hidden !important;
            position: relative !important;
        }
        
        /* ApexCharts CSS removed - now using Chart.js */
        
    </style>
</head>
<body class="bg-gray-900 min-h-screen gold-bg" data-theme="dark">

    <!-- Navigation -->
    <nav class="gradient-bg shadow-lg relative z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="aurora-text text-xl font-bold flex items-center">
                            <img src="/static/phoenyra_logo.png" alt="Phoenyra Logo" class="h-16 w-auto mr-3 object-contain">
                            Phoenyra BESS Trade
                        </h1>
                    </div>
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-2">
                            <a href="/" class="nav-link text-white hover:bg-white hover:bg-opacity-20 px-2 py-2 rounded-md text-xs font-medium transition-all duration-300" data-path="/" title="Dashboard">
                                <i class="fas fa-tachometer-alt mr-1"></i><span class="hidden lg:inline">Dashboard</span>
                            </a>
                            <a href="/forecast" class="nav-link text-white hover:bg-white hover:bg-opacity-20 px-2 py-2 rounded-md text-xs font-medium transition-all duration-300" data-path="/forecast" title="Forecast">
                                <i class="fas fa-crystal-ball mr-1"></i><span class="hidden lg:inline">Forecast</span>
                            </a>
                            <a href="/risk" class="nav-link text-white hover:bg-white hover:bg-opacity-20 px-2 py-2 rounded-md text-xs font-medium transition-all duration-300" data-path="/risk" title="Risk">
                                <i class="fas fa-shield-alt mr-1"></i><span class="hidden lg:inline">Risk</span>
                            </a>
                            <a href="/grid" class="nav-link text-white hover:bg-white hover:bg-opacity-20 px-2 py-2 rounded-md text-xs font-medium transition-all duration-300" data-path="/grid" title="Grid">
                                <i class="fas fa-plug mr-1"></i><span class="hidden lg:inline">Grid</span>
                            </a>
                            <a href="/credit" class="nav-link text-white hover:bg-white hover:bg-opacity-20 px-2 py-2 rounded-md text-xs font-medium transition-all duration-300" data-path="/credit" title="Credit">
                                <i class="fas fa-wallet mr-1"></i><span class="hidden lg:inline">Credit</span>
                            </a>
                            <a href="/billing" class="nav-link text-white hover:bg-white hover:bg-opacity-20 px-2 py-2 rounded-md text-xs font-medium transition-all duration-300" data-path="/billing" title="Billing">
                                <i class="fas fa-file-invoice-dollar mr-1"></i><span class="hidden lg:inline">Billing</span>
                            </a>
                            <a href="/config" class="nav-link text-white hover:bg-white hover:bg-opacity-20 px-2 py-2 rounded-md text-xs font-medium transition-all duration-300" data-path="/config" title="Konfiguration">
                                <i class="fas fa-cog mr-1"></i><span class="hidden lg:inline">Config</span>
                            </a>
                            <a href="/trading-config" class="nav-link text-white hover:bg-white hover:bg-opacity-20 px-2 py-2 rounded-md text-xs font-medium transition-all duration-300" data-path="/trading-config" title="Trading-Config">
                                <i class="fas fa-key mr-1"></i><span class="hidden lg:inline">Trading</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="flex items-center space-x-2">
                        {% if session.user %}
                        <div class="flex items-center space-x-2 bg-gray-700 bg-opacity-50 px-2 py-1 rounded-md">
                            <i class="fas fa-user text-blue-400 text-xs"></i>
                            <span class="text-white text-xs">{{ session.user.name }}</span>
                            <span class="text-gray-400 text-xs">({{ session.user.role }})</span>
                        </div>
                        <a href="/logout" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-md text-xs font-medium transition-all duration-300" title="Abmelden">
                            <i class="fas fa-sign-out-alt"></i>
                        </a>
                        {% endif %}
                        <span class="text-white text-xs hidden sm:inline" id="connection-status">
                            <span class="status-indicator status-offline"></span>
                            <span class="hidden md:inline">Verbindung wird hergestellt...</span>
                        </span>
                        <div class="flex flex-col items-end text-xs">
                            <span class="text-white" id="current-date"></span>
                            <span class="text-white font-medium" id="current-time"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="gold-footer mt-auto relative">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 relative z-10">
            <div class="flex justify-between items-center">
                <div class="text-sm text-gray-300">
                    Phoenyra BESS Trade System v2.0
                </div>
                <div class="text-sm text-gray-300">
                    © 2025 Phoenyra.com by Ing. Heinz Schlagintweit. Alle Rechte vorbehalten.
                </div>
            </div>
        </div>
    </footer>

    <!-- Socket.IO Script -->
    <script>
        let socket;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;
        
        function initSocket() {
            socket = io({
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionAttempts: maxReconnectAttempts,
                reconnectionDelay: 1000,
                timeout: 5000
            });
            
            socket.on('connect', function() {
                reconnectAttempts = 0;
                const statusEl = document.getElementById('connection-status');
                if (statusEl) {
                    statusEl.innerHTML = 
                        '<span class="status-indicator status-online"></span>Verbunden';
                }
                console.log('Socket.IO: Verbunden');
            });
            
            socket.on('disconnect', function(reason) {
                const statusEl = document.getElementById('connection-status');
                if (statusEl) {
                    statusEl.innerHTML = 
                        '<span class="status-indicator status-offline"></span>Verbindung getrennt';
                }
                console.log('Socket.IO: Getrennt - Grund:', reason);
                
                // Versuche automatisch wiederzuverbinden
                if (reconnectAttempts < maxReconnectAttempts) {
                    setTimeout(() => {
                        reconnectAttempts++;
                        if (statusEl) {
                            statusEl.innerHTML = 
                                '<span class="status-indicator status-warning"></span>Wiederherstellung...';
                        }
                        socket.connect();
                    }, 2000);
                }
            });
            
            socket.on('connect_error', function(error) {
                reconnectAttempts++;
                const statusEl = document.getElementById('connection-status');
                if (statusEl) {
                    if (reconnectAttempts >= maxReconnectAttempts) {
                        statusEl.innerHTML = 
                            '<span class="status-indicator status-warning"></span>Offline (API verfügbar)';
                    } else if (reconnectAttempts < 3) {
                        statusEl.innerHTML = 
                            '<span class="status-indicator status-warning"></span>Verbinden...';
                    } else {
                        // Nach 3 Versuchen: Zeige dass API funktioniert
                        statusEl.innerHTML = 
                            '<span class="status-indicator status-warning"></span>Offline (API verfügbar)';
                    }
                }
                console.log('Socket.IO Verbindungsfehler:', error);
            });
            
            socket.on('order_update', function(data) {
                console.log('Order Update:', data);
                // Handle order updates here
            });
            
            // Set initial status
            const statusEl = document.getElementById('connection-status');
            if (statusEl && !socket.connected) {
                statusEl.innerHTML = 
                    '<span class="status-indicator status-warning"></span>Verbinden...';
            }
        }
        
        // Initialize socket connection
        initSocket();
        
        // Fallback: Wenn nach 5 Sekunden keine Verbindung, zeige "API verfügbar"
        setTimeout(() => {
            const statusEl = document.getElementById('connection-status');
            if (statusEl && !socket.connected) {
                statusEl.innerHTML = 
                    '<span class="status-indicator status-warning"></span>Offline (API verfügbar)';
            }
        }, 5000);
        
        // Update date and time every second
        function updateDateTime() {
            const now = new Date();
            document.getElementById('current-date').textContent = 
                now.toLocaleDateString('de-DE');
            document.getElementById('current-time').textContent = 
                now.toLocaleTimeString('de-DE');
        }
        updateDateTime();
        setInterval(updateDateTime, 1000);
        
        // Dark Mode Only - No Theme Toggle
        const body = document.body;
        body.setAttribute('data-theme', 'dark');
        
        // Active menu link highlighting
        function setActiveMenuItem() {
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                const linkPath = link.getAttribute('data-path');
                // Remove active class from all links
                link.classList.remove('bg-white', 'bg-opacity-15', 'border-b-2', 'border-yellow-500');
                
                // Check if this is the active link
                if (linkPath === currentPath || (currentPath === '/' && linkPath === '/')) {
                    // Add active styling
                    link.classList.add('bg-white', 'bg-opacity-15', 'border-b-2', 'border-yellow-500');
                    link.style.transition = 'all 0.3s ease';
                }
            });
        }
        
        // Set active menu on page load
        setActiveMenuItem();
        
        // Update on navigation (for SPA-like behavior)
        window.addEventListener('popstate', setActiveMenuItem);
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
